name: Auto-Regenerate Connector on OpenAPI Change

on:
  workflow_dispatch:
    inputs:
      openapi-url:
        description: "URL of the updated OpenAPI spec"
        required: true
        type: string
      connector-path:
        description: "Relative path of the connector module (e.g. stdlib/github)"
        required: true
        type: string
      ballerina-version:
        required: false
        default: "2201.13.0"
        type: string

jobs:
  regenerate:
    runs-on: ubuntu-22.04
    env:
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

    steps:
    # -------------------------------------------------
    # 1. Checkout repo
    # -------------------------------------------------
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.BALLERINA_BOT_TOKEN }}

    # -------------------------------------------------
    # 2. Setup Ballerina
    # -------------------------------------------------
    - name: Setup Ballerina
      uses: ballerina-platform/setup-ballerina@v1.1.3
      with:
        version: ${{ inputs.ballerina-version }}

    # -------------------------------------------------
    # 3. Snapshot OLD connector
    # -------------------------------------------------
    - name: Save old connector snapshot
      run: |
        mkdir -p /tmp/old
        cp -r "${{ inputs.connector-path }}" /tmp/old/
        echo "Old connector snapshot saved"

    # -------------------------------------------------
    # 4. Download OpenAPI spec
    # -------------------------------------------------
    - name: Download OpenAPI spec
      run: |
        mkdir -p docs/spec
        cd docs/spec
        wget -O openapi.yaml "${{ inputs.openapi-url }}"

    # -------------------------------------------------
    # 5. Clone connector automator
    # -------------------------------------------------
    - name: Clone connector automator
      run: |
        git clone -b connector-automation https://github.com/nostoc/ballerina-library.git temp
        cp -r temp/connector_automator ./
        rm -rf temp

    # -------------------------------------------------
    # 6. Run connector generation pipeline
    # -------------------------------------------------
    - name: Generate connector
      run: |
        cd connector_automator

        cat > Config.toml << EOF
        [connector_automator.utils]
        apiKey = "${ANTHROPIC_API_KEY}"
        EOF

        bal run -- pipeline \
          "${GITHUB_WORKSPACE}/docs/spec/openapi.yaml" \
          "${GITHUB_WORKSPACE}" \
          yes quiet

    # -------------------------------------------------
    # 7. Snapshot NEW connector
    # -------------------------------------------------
    - name: Save new connector snapshot
      run: |
        mkdir -p /tmp/new
        cp -r "${{ inputs.connector-path }}" /tmp/new/
        echo "New connector snapshot saved"

    # -------------------------------------------------
    # 8. Generate diff
    # -------------------------------------------------
    - name: Generate connector diff
      run: |
        diff -ru /tmp/old /tmp/new > connector.diff || true
        echo "Diff generated"

    # -------------------------------------------------
    # 9. LLM-based change classification
    # -------------------------------------------------
    - name: Classify changes using LLM
      id: classify
      run: |
        PROMPT=$(cat << 'EOF'
You are an expert in Ballerina connector APIs.

Analyze the following diff and determine the semantic version impact.

Rules:
- Ignore formatting, comments, and internal refactoring
- Added optional fields or endpoints → MINOR
- Removed or changed public APIs/types → MAJOR
- Bug fixes or doc-only changes → PATCH
- No public API changes → NONE

Respond ONLY in JSON.

{
  "impact": "MAJOR | MINOR | PATCH | NONE",
  "reason": "short explanation"
}
EOF
        )

        RESPONSE=$(curl https://api.anthropic.com/v1/messages \
          -H "Authorization: Bearer $ANTHROPIC_API_KEY" \
          -H "Content-Type: application/json" \
          -d "{
            \"model\": \"claude-3-sonnet-20240229\",
            \"max_tokens\": 500,
            \"messages\": [{
              \"role\": \"user\",
              \"content\": \"$PROMPT\n\nDIFF:\n$(sed 's/\"/\\\\\"/g' connector.diff)\"
            }]
          }")

        echo "$RESPONSE" > llm.json
        IMPACT=$(jq -r '.content[0].text | fromjson | .impact' llm.json)
        echo "impact=$IMPACT" >> $GITHUB_OUTPUT

    # -------------------------------------------------
    # 10. Version bump
    # -------------------------------------------------
    - name: Apply semantic version bump
      if: steps.classify.outputs.impact != 'NONE'
      run: |
        cd "${{ inputs.connector-path }}"

        case "${{ steps.classify.outputs.impact }}" in
          MAJOR) bal version bump major ;;
          MINOR) bal version bump minor ;;
          PATCH) bal version bump patch ;;
        esac

    # -------------------------------------------------
    # 11. Cleanup
    # -------------------------------------------------
    - name: Cleanup
      run: |
        rm -rf connector_automator
        find . -name "target" -type d -exec rm -rf {} +
        find . -name "*.backup" -delete

    # -------------------------------------------------
    # 12. Commit & PR
    # -------------------------------------------------
    - name: Commit changes
      run: |
        git config user.name "ballerina-bot"
        git config user.email "ballerina-bot@ballerina.org"

        git checkout -b auto-update-${{ inputs.connector-path }}

        git add .
        git commit -m "[AUTOMATED] Update connector (${{
          steps.classify.outputs.impact }}) from OpenAPI change"

        git push origin HEAD

    - name: Create PR
      run: |
        gh pr create \
          --title "[Automated] Connector update (${{
            steps.classify.outputs.impact }})" \
          --body "AI-classified impact: **${{
            steps.classify.outputs.impact }}**  
Reason: $(jq -r '.content[0].text | fromjson | .reason' llm.json)" \
          --base main
      env:
        GITHUB_TOKEN: ${{ secrets.BALLERINA_BOT_TOKEN }}
